<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FastUIDraw: Example Custom Brush</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FastUIDraw
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Example Custom Brush </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Example on how to create a custom-brush that builds from teh standard brush.</p>
<p>The Example Custom Brush builds from <a class="el" href="../../de/d50/ex_initialization.html">Example Initialization</a> to demonstrate how to create a custom-brush that builds from the standard brush. The example custom is implemented by modifying in the fragment shader the brush position fed to the standard brush.</p>
<p>A custom brush is defined essentially by two elements: a shader and data to feed the shader. The shader is represented by <a class="el" href="../../d9/dd0/classfastuidraw_1_1_painter_brush_shader.html">fastuidraw::PainterBrushShader</a> and the data to feed it is represented by <a class="el" href="../../d9/dd2/classfastuidraw_1_1_painter_brush_shader_data.html">fastuidraw::PainterBrushShaderData</a>. The data represents the small amount of data that the shader unpacks from the data store.</p>
<p>The implementation of the data used by the custom brush and the shader for it is given by </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../db/ddf/static__resource_8hpp.html">fastuidraw/util/static_resource.hpp</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d2/d0c/painter__brush__shader__data_8hpp.html">fastuidraw/painter/painter_brush_shader_data.hpp</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../da/dfb/painter__brush__shader__glsl_8hpp.html">fastuidraw/glsl/painter_brush_shader_glsl.hpp</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* The data of a custom brush is represented by an object of type</span></div><div class="line"><span class="comment"> * derived from fastuidraw::PainterBrushShaderData.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">class </span>ExampleCustomBrushData:<span class="keyword">public</span> <a class="code" href="../../d9/dd2/classfastuidraw_1_1_painter_brush_shader_data.html">fastuidraw::PainterBrushShaderData</a></div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  ExampleCustomBrushData(<span class="keywordtype">void</span>):</div><div class="line">    m_phase(0.0f),</div><div class="line">    m_amplitude(0.0f),</div><div class="line">    m_period(1.0f)</div><div class="line">  {}</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">   * Data size is how many -scalar- values that the object will</span></div><div class="line"><span class="comment">   * add to the data store. This value must ALWAYS be a multiple</span></div><div class="line"><span class="comment">   * of 4.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span></div><div class="line">  <a class="code" href="../../d9/dd2/classfastuidraw_1_1_painter_brush_shader_data.html#adab5c95097cc7a61dd428af7e3b6af33">data_size</a>(<span class="keywordtype">void</span>)<span class="keyword"> const override</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="comment">/* Our object is just a few floats (m_phase, m_amplitude and m_period)</span></div><div class="line"><span class="comment">     * toegher with the data from a fastuidraw::PainterBrush. In order</span></div><div class="line"><span class="comment">     * to seemlessly use fastuidraw::PainterBrush as a dependency, its</span></div><div class="line"><span class="comment">     * data must also start on a multiple-of-4 boundary. So, we just</span></div><div class="line"><span class="comment">     * return 4 + how much data the PainterBrush neededs.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">return</span> 4 + m_brush_values.data_size();</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* Packing the data represents placing the data into the data store</span></div><div class="line"><span class="comment">   * which will be extacted on GPU by the shader.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  <a class="code" href="../../d9/dd2/classfastuidraw_1_1_painter_brush_shader_data.html#acf105d1484635b15b85ccf33175d6614">pack_data</a>(<a class="code" href="../../de/df7/classfastuidraw_1_1c__array.html">fastuidraw::c_array&lt;fastuidraw::generic_data&gt;</a> dst)<span class="keyword"> const override</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="comment">/* We place the data of (m_phase, m_amplitude and m_period) first. */</span></div><div class="line">    dst[0].f = m_phase;</div><div class="line">    dst[1].f = m_period;</div><div class="line">    dst[2].f = m_amplitude;</div><div class="line"></div><div class="line">    <span class="comment">/* then place the data of the PainterBrush after our data starting</span></div><div class="line"><span class="comment">     * at 4-boundary of generic_data.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    m_brush_values.pack_data(dst.<a class="code" href="../../de/df7/classfastuidraw_1_1c__array.html#aa73202f716ded74f65c63a0e7b2b88fa">sub_array</a>(4));</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* PainterBrushShaderData need to indicate how many resources they use.</span></div><div class="line"><span class="comment">   * A resource is any object that must stay alive for the custom brush</span></div><div class="line"><span class="comment">   * to correctly execute. Typically resources are just fastuidraw::Image</span></div><div class="line"><span class="comment">   * and fastuidraw::ColorStopSequenceOnAtlas objects. In this example</span></div><div class="line"><span class="comment">   * the resources are coming from only the PainterBrush m_brush_values,</span></div><div class="line"><span class="comment">   * so we use its return values.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span></div><div class="line">  <a class="code" href="../../d9/dd2/classfastuidraw_1_1_painter_brush_shader_data.html#a1ad2bd5d463073df423e54d2059dfd7c">number_resources</a>(<span class="keywordtype">void</span>)<span class="keyword"> const override</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">return</span> m_brush_values.number_resources();</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* The function fill an array of size number_resources() to save the resource</span></div><div class="line"><span class="comment">   * references to gaurnatee that the resources stay in scope.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  <a class="code" href="../../d9/dd2/classfastuidraw_1_1_painter_brush_shader_data.html#a4c0c9ec8fc5c3ae2e8f1fc1a0076ada0">save_resources</a>(<a class="code" href="../../de/df7/classfastuidraw_1_1c__array.html">fastuidraw::c_array</a>&lt;<a class="code" href="../../de/d73/classfastuidraw_1_1reference__counted__ptr.html">fastuidraw::reference_counted_ptr&lt;const fastuidraw::resource_base&gt;</a> &gt; dst)<span class="keyword"> const override</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    m_brush_values.save_resources(dst);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* A PainterBrushShaderData also needs to inform FastUIDraw what Image objects</span></div><div class="line"><span class="comment">   * it uses that need to be bound by a 3D API call. Images that need to be bound</span></div><div class="line"><span class="comment">   * are just those images whose Image::type() is Image::context_texture2d. In this</span></div><div class="line"><span class="comment">   * example, the only image data that the brush has comes exactly from PainterBrush.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <a class="code" href="../../de/df7/classfastuidraw_1_1c__array.html">fastuidraw::c_array&lt;const fastuidraw::reference_counted_ptr&lt;const fastuidraw::Image&gt;</a> &gt;</div><div class="line">  <a class="code" href="../../d9/dd2/classfastuidraw_1_1_painter_brush_shader_data.html#a611e04f183ac2b36ab59696b7611fd62">bind_images</a>(<span class="keywordtype">void</span>)<span class="keyword"> const override</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">return</span> m_brush_values.bind_images();</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* The waviness of the brush is defined by these 3 values</span></div><div class="line"><span class="comment">   * - m_phase gives the phase of wave (so we can animate it)</span></div><div class="line"><span class="comment">   * - m_period gives the period of the brush</span></div><div class="line"><span class="comment">   * - m_amplitude gives the amplitude of the wave</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keywordtype">float</span> m_phase, m_period, m_amplitude;</div><div class="line"></div><div class="line">  <span class="comment">/* Our example builds off of the standard brush */</span></div><div class="line">  <a class="code" href="../../d9/d57/classfastuidraw_1_1_painter_brush.html">fastuidraw::PainterBrush</a> m_brush_values;</div><div class="line">};</div><div class="line"></div><div class="line"><a class="code" href="../../de/d73/classfastuidraw_1_1reference__counted__ptr.html">fastuidraw::reference_counted_ptr&lt;fastuidraw::PainterBrushShader&gt;</a></div><div class="line">create_wavy_custom_brush(<a class="code" href="../../d5/ddf/classfastuidraw_1_1gl_1_1_painter_engine_g_l.html">fastuidraw::gl::PainterEngineGL</a> *painter_engine_gl)</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="../../d4/d4c/namespacefastuidraw.html">fastuidraw</a>;</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="../../d5/da7/namespacefastuidraw_1_1gl.html">fastuidraw::gl</a>;</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="../../df/d7b/namespacefastuidraw_1_1glsl.html">fastuidraw::glsl</a>;</div><div class="line"></div><div class="line">  <span class="comment">/* Get the brush shader for the default shader brush */</span></div><div class="line">  <span class="keyword">const</span> <a class="code" href="../../db/d4b/classfastuidraw_1_1_painter_shader_set.html">PainterShaderSet</a> &amp;default_shaders(painter_engine_gl-&gt;<a class="code" href="../../da/d11/classfastuidraw_1_1_painter_engine.html#a94abfa85ea38b11afb1722cec48f78af">default_shaders</a>());</div><div class="line">  <span class="keyword">const</span> <a class="code" href="../../d9/de8/classfastuidraw_1_1_painter_brush_shader_set.html">PainterBrushShaderSet</a> &amp;default_brushes(default_shaders.brush_shaders());</div><div class="line">  <a class="code" href="../../de/d73/classfastuidraw_1_1reference__counted__ptr.html">reference_counted_ptr&lt;PainterBrushShader&gt;</a> strandard_brush(default_brushes.standard_brush());</div><div class="line"></div><div class="line">  <span class="comment">/* Our custom brush is going to use the default standard brush. We need to</span></div><div class="line"><span class="comment">   * declare in the PainterBrushShaderGLSL ctor what other brush shaders it</span></div><div class="line"><span class="comment">   * will use and how it will refer to them. Below we create (on the stack)</span></div><div class="line"><span class="comment">   * a DependencyList object and add to it that our custom shader will use</span></div><div class="line"><span class="comment">   * the default brush shader and refer via standard_brush. In the shader</span></div><div class="line"><span class="comment">   * code, we can call its shader by calling the function standrad_brush().</span></div><div class="line"><span class="comment">   * In addition, we can also read and write any of its varyings as well.</span></div><div class="line"><span class="comment">   * For each varying FOO of the default shader brush, we can access that</span></div><div class="line"><span class="comment">   * varying as standard_brush_FOO.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <a class="code" href="../../d8/d86/classfastuidraw_1_1glsl_1_1_painter_brush_shader_g_l_s_l_1_1_dependency_list.html">PainterBrushShaderGLSL::DependencyList</a> deps;</div><div class="line">  deps.<a class="code" href="../../d8/d86/classfastuidraw_1_1glsl_1_1_painter_brush_shader_g_l_s_l_1_1_dependency_list.html#a3fd16fe30a0f63d050100cf05733764f">add_shader</a>(<span class="stringliteral">&quot;standard_brush&quot;</span>, strandard_brush.static_cast_ptr&lt;<a class="code" href="../../d8/d41/classfastuidraw_1_1glsl_1_1_painter_brush_shader_g_l_s_l.html">PainterBrushShaderGLSL</a>&gt;());</div><div class="line"></div><div class="line">  <span class="comment">/* The vertex shader of our custom brush, the main point of interest</span></div><div class="line"><span class="comment">   * is that it calls the vertext shader of the default brush by calling</span></div><div class="line"><span class="comment">   * standard_brush(). Note that we pass 0 as the sub_shader to the</span></div><div class="line"><span class="comment">   * standard brush and that we pass shader_data_offset + 1 as the</span></div><div class="line"><span class="comment">   * shader data offset. The &quot;+1&quot; is there because the PainterBrush</span></div><div class="line"><span class="comment">   * data was packed 4 generic_data elements AFTER the start of the</span></div><div class="line"><span class="comment">   * array passed to pack_data(). A single uvec4 value in GLSL corresponds</span></div><div class="line"><span class="comment">   * to 4 generic_data elements.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *custom_brush_vert_shader =</div><div class="line">    <span class="stringliteral">&quot;void\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;fastuidraw_gl_vert_brush_main(in uint sub_shader,\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;                              in uint shader_data_offset,\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;                              in vec2 brush_p)\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;{\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;  standard_brush(0, shader_data_offset + 1, brush_p);\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;}\n&quot;</span>;</div><div class="line"></div><div class="line">  <span class="comment">/* The fragment shader of our custom brush. It first unpacks</span></div><div class="line"><span class="comment">   * m_phase, m_period and m_amplitude from the shader data.</span></div><div class="line"><span class="comment">   * From there is modifies the varying of the default brush,</span></div><div class="line"><span class="comment">   * fastuidraw_brush_p_x, by manipulating the value of</span></div><div class="line"><span class="comment">   * standard_brush_fastuidraw_brush_p_x. Internally, these</span></div><div class="line"><span class="comment">   * name aliases are implemented by macros. Finally, after</span></div><div class="line"><span class="comment">   * changing the brush position, it calls the default brush</span></div><div class="line"><span class="comment">   * by calling standard_brush().</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *custom_brush_frag_shader =</div><div class="line">    <span class="stringliteral">&quot;vec4\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;fastuidraw_gl_frag_brush_main(in uint sub_shader,\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;                              in uint shader_data_offset)\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;{\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;   const float PI = 3.14159265358979323846;\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;   uvec3 packed_value;\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;   float phase, period, amplitude;\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;   packed_value = fastuidraw_fetch_data(shader_data_offset).xyz;\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;   phase = uintBitsToFloat(packed_value.x);\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;   period = uintBitsToFloat(packed_value.y);\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;   amplitude = uintBitsToFloat(packed_value.z);\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;   standard_brush_fastuidraw_brush_p_x += amplitude * cos((2.0 * PI / period) * (phase + standard_brush_fastuidraw_brush_p_y));\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;   return standard_brush(sub_shader, shader_data_offset + 1);\n&quot;</span></div><div class="line">    <span class="stringliteral">&quot;}\n&quot;</span>;</div><div class="line"></div><div class="line">  <span class="comment">/* When creating the ShaderSource objects to pass to the ctor of</span></div><div class="line"><span class="comment">   * PainterBrushShader, we can elect to take the sources from</span></div><div class="line"><span class="comment">   * a string, a file or a resource. When we take a string from</span></div><div class="line"><span class="comment">   * a file or resource, the uber-shader assembly can list what the</span></div><div class="line"><span class="comment">   * name of the file or resource if one dumps the shader source.</span></div><div class="line"><span class="comment">   * To aid in debugging it is usually BEST to take shader source</span></div><div class="line"><span class="comment">   * from a file or resource for just that reason.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <a class="code" href="../../da/d46/group___utility.html#gabf43867b6dc6abcb6c649bbf2a675bee">generate_static_resource</a>(<span class="stringliteral">&quot;custom_brush_vert_shader&quot;</span>, custom_brush_vert_shader);</div><div class="line">  <a class="code" href="../../da/d46/group___utility.html#gabf43867b6dc6abcb6c649bbf2a675bee">generate_static_resource</a>(<span class="stringliteral">&quot;custom_brush_frag_shader&quot;</span>, custom_brush_frag_shader);</div><div class="line"></div><div class="line">  <a class="code" href="../../d5/db9/classfastuidraw_1_1glsl_1_1_shader_source.html">ShaderSource</a> vert, frag;</div><div class="line"></div><div class="line">  vert.<a class="code" href="../../d5/db9/classfastuidraw_1_1glsl_1_1_shader_source.html#a041c46d1550133e409aa8034d8fc4541">add_source</a>(<span class="stringliteral">&quot;custom_brush_vert_shader&quot;</span>, ShaderSource::from_resource);</div><div class="line">  frag.<a class="code" href="../../d5/db9/classfastuidraw_1_1glsl_1_1_shader_source.html#a041c46d1550133e409aa8034d8fc4541">add_source</a>(<span class="stringliteral">&quot;custom_brush_frag_shader&quot;</span>, ShaderSource::from_resource);</div><div class="line"></div><div class="line">  <span class="comment">/* The ctor of PainterBrushShaderGLSL needs to know how many</span></div><div class="line"><span class="comment">   * context textures the custom brushes shaders used DIRECTLY,</span></div><div class="line"><span class="comment">   * i.e. NOT counting the number coming from the dependencies.</span></div><div class="line"><span class="comment">   * In this example, our new shader code does not use any context</span></div><div class="line"><span class="comment">   * textures, so the value is 0.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> number_context_textures(0);</div><div class="line"></div><div class="line">  <span class="comment">/* The ctor of PainterBrushShaderGLSL needs to know the varyings</span></div><div class="line"><span class="comment">   * that our custom brush creates. This varying list does NOT</span></div><div class="line"><span class="comment">   * include the varyings from shaders listed in the DependencyList</span></div><div class="line"><span class="comment">   * object passed. In our simple example we have no varyings so</span></div><div class="line"><span class="comment">   * we do not add any elements to the varying_list object.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <a class="code" href="../../d5/da3/classfastuidraw_1_1glsl_1_1varying__list.html">varying_list</a> varyings;</div><div class="line"></div><div class="line">  <a class="code" href="../../de/d73/classfastuidraw_1_1reference__counted__ptr.html">reference_counted_ptr&lt;PainterBrushShader&gt;</a> return_value;</div><div class="line">  return_value = <a class="code" href="../../da/d46/group___utility.html#ga524a8b6674554f360cf8b04a3a6a37b0">FASTUIDRAWnew</a> <a class="code" href="../../d8/d41/classfastuidraw_1_1glsl_1_1_painter_brush_shader_g_l_s_l.html">PainterBrushShaderGLSL</a>(number_context_textures,</div><div class="line">                                                      vert, frag,</div><div class="line">                                                      varyings, deps);</div><div class="line"></div><div class="line">  <span class="comment">/* Before the shader can be used, it must be registered. */</span></div><div class="line">  painter_engine_gl-&gt;<a class="code" href="../../da/d11/classfastuidraw_1_1_painter_engine.html#aa09cc6db837322e563afcdddb18b6a80">painter_shader_registrar</a>().<a class="code" href="../../d2/d52/classfastuidraw_1_1_painter_shader_registrar.html#a2e7fc8ab91da25f34127002638237f31">register_shader</a>(return_value);</div><div class="line"></div><div class="line">  <span class="comment">/* One big danger of having custom shaders is that if the GLSL code we gave</span></div><div class="line"><span class="comment">   * has a syntax error, then the entire uber-shader cannot be compiled by</span></div><div class="line"><span class="comment">   * the GL implementation. For debugging, we check if the uber-shader could</span></div><div class="line"><span class="comment">   * be compiled/linked and if not bail out and save the logs and built shader</span></div><div class="line"><span class="comment">   * source so that we can fix any errors in our shader code.</span></div><div class="line"><span class="comment">   */</span></div><div class="line"><span class="preprocessor">  #ifdef FASTUIDRAW_DEBUG</span></div><div class="line">    {</div><div class="line">      <a class="code" href="../../de/d73/classfastuidraw_1_1reference__counted__ptr.html">reference_counted_ptr&lt;Program&gt;</a> pr;</div><div class="line"></div><div class="line">      <span class="comment">/* There are several GLSL programs that the painter engine</span></div><div class="line"><span class="comment">       * actually has, For simplicity we grab the GLSL program</span></div><div class="line"><span class="comment">       * that is used to draw any item that is blended with a</span></div><div class="line"><span class="comment">       * blend shader that uses single-src blending.</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      pr = painter_engine_gl-&gt;<a class="code" href="../../d5/ddf/classfastuidraw_1_1gl_1_1_painter_engine_g_l.html#aea34fe0f6fc4d782dbe717eabfc309c0">program</a>(PainterEngineGL::program_all, PainterBlendShader::single_src);</div><div class="line">      <span class="keywordflow">if</span> (!pr-&gt;<a class="code" href="../../d0/d53/classfastuidraw_1_1gl_1_1_program.html#a2cd912e1ac823d5504ad707ce14eae7b">link_success</a>())</div><div class="line">        {</div><div class="line">          std::cout &lt;&lt; <span class="stringliteral">&quot;Uber GLSL-program failed to be linked, dumping logs and sources of it\n&quot;</span>;</div><div class="line"></div><div class="line">          std::ofstream program_log(<span class="stringliteral">&quot;program_log.txt&quot;</span>);</div><div class="line">          program_log &lt;&lt; <span class="stringliteral">&quot;Log:\n&quot;</span> &lt;&lt; pr-&gt;<a class="code" href="../../d0/d53/classfastuidraw_1_1gl_1_1_program.html#a8a942504ab596a9094fc74d43d81e126">log</a>()</div><div class="line">                      &lt;&lt; <span class="stringliteral">&quot;\nLinkLog:\n&quot;</span> &lt;&lt; pr-&gt;<a class="code" href="../../d0/d53/classfastuidraw_1_1gl_1_1_program.html#afea70353322dcf6c4d1ee7bf4ac972ef">link_log</a>()</div><div class="line">                      &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"></div><div class="line">          <span class="comment">/* For each shader of the program, dump its compile log</span></div><div class="line"><span class="comment">           * and original shader source.</span></div><div class="line"><span class="comment">           */</span></div><div class="line">          GLenum tps[2] = {GL_VERTEX_SHADER, GL_FRAGMENT_SHADER};</div><div class="line">          <span class="keywordflow">for</span> (GLenum tp : tps)</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0, endi = pr-&gt;<a class="code" href="../../d0/d53/classfastuidraw_1_1gl_1_1_program.html#ae4eb2f90d7014264e605d33ae9c31501">num_shaders</a>(tp); i &lt; endi; ++i)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">if</span> (!pr-&gt;<a class="code" href="../../d0/d53/classfastuidraw_1_1gl_1_1_program.html#afb679db5609e1d8cc59959e913b7ecf0">shader_compile_success</a>(tp, i))</div><div class="line">                    {</div><div class="line">                      std::ostringstream name_common, name_log, name_src;</div><div class="line">                      name_common &lt;&lt; <span class="stringliteral">&quot;compliled_failed.shader_&quot;</span> &lt;&lt; i</div><div class="line">                                  &lt;&lt; <span class="stringliteral">&quot;.&quot;</span> &lt;&lt; Shader::gl_shader_type_label(tp)</div><div class="line">                                  &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>;</div><div class="line">                      name_log &lt;&lt; name_common.str() &lt;&lt; <span class="stringliteral">&quot;log&quot;</span>;</div><div class="line">                      name_src &lt;&lt; name_common.str() &lt;&lt; <span class="stringliteral">&quot;glsl&quot;</span>;</div><div class="line"></div><div class="line">                      std::ofstream shader_log(name_log.str().c_str());</div><div class="line">                      std::ofstream shader_src(name_src.str().c_str());</div><div class="line"></div><div class="line">                      shader_log &lt;&lt; pr-&gt;<a class="code" href="../../d0/d53/classfastuidraw_1_1gl_1_1_program.html#a5c080edebfbe712ca987a95ca77a2622">shader_compile_log</a>(tp, i);</div><div class="line"></div><div class="line">                      <span class="comment">/* The shader_src_code() returns of the uber shader, that</span></div><div class="line"><span class="comment">                       * source code will also have a comment at the end of each</span></div><div class="line"><span class="comment">                       * line giving the line number of from where the source comes</span></div><div class="line"><span class="comment">                       * when the source comes from a file or a resource.</span></div><div class="line"><span class="comment">                       */</span></div><div class="line">                      shader_src &lt;&lt; pr-&gt;<a class="code" href="../../d0/d53/classfastuidraw_1_1gl_1_1_program.html#a00a8b9311bb817fd60026cb2e81717e0">shader_src_code</a>(tp, i);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">          return_value = <span class="keyword">nullptr</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"><span class="preprocessor">  #endif</span></div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> return_value;</div><div class="line">}</div></div><!-- fragment --><p> The implementation of using the custom brush is given by </p><div class="fragment"><div class="line"></div><div class="line"><span class="keyword">class </span>ExampleCustomBrush:<span class="keyword">public</span> Initialization</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  ExampleCustomBrush(DemoRunner *runner, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv);</div><div class="line"></div><div class="line">  ~ExampleCustomBrush()</div><div class="line">  {}</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span></div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  draw_frame(<span class="keywordtype">void</span>) <span class="keyword">override</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <a class="code" href="../../de/d73/classfastuidraw_1_1reference__counted__ptr.html">fastuidraw::reference_counted_ptr&lt;const fastuidraw::ColorStopSequenceOnAtlas&gt;</a> m_color_stops;</div><div class="line">  <a class="code" href="../../de/d73/classfastuidraw_1_1reference__counted__ptr.html">fastuidraw::reference_counted_ptr&lt;fastuidraw::PainterBrushShader&gt;</a> m_custom_brush_shader;</div><div class="line">  <a class="code" href="../../de/d73/classfastuidraw_1_1reference__counted__ptr.html">fastuidraw::reference_counted_ptr&lt;const fastuidraw::Image&gt;</a> m_image;</div><div class="line">};</div><div class="line"></div><div class="line">ExampleCustomBrush::</div><div class="line">ExampleCustomBrush(DemoRunner *runner, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv):</div><div class="line">  Initialization(runner, argc, argv)</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="../../d4/d4c/namespacefastuidraw.html">fastuidraw</a>;</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="../../df/d7b/namespacefastuidraw_1_1glsl.html">fastuidraw::glsl</a>;</div><div class="line"></div><div class="line">  <span class="comment">/* Make a simple color-stop-sequence with 4 color-stops. */</span></div><div class="line">  <a class="code" href="../../d6/de3/classfastuidraw_1_1_color_stop_sequence.html">ColorStopSequence</a> seq;</div><div class="line"></div><div class="line">  seq.<a class="code" href="../../d6/de3/classfastuidraw_1_1_color_stop_sequence.html#aa2b72211f82b6e96adb5600ea0ec29ec">add</a>(<a class="code" href="../../dd/d78/classfastuidraw_1_1_color_stop.html">ColorStop</a>(<a class="code" href="../../da/d46/group___utility.html#ga562bee0305892c513b6cef2b42e39116">u8vec4</a>(27, 27, 255, 255), 0.0f));</div><div class="line">  seq.<a class="code" href="../../d6/de3/classfastuidraw_1_1_color_stop_sequence.html#aa2b72211f82b6e96adb5600ea0ec29ec">add</a>(<a class="code" href="../../dd/d78/classfastuidraw_1_1_color_stop.html">ColorStop</a>(<a class="code" href="../../da/d46/group___utility.html#ga562bee0305892c513b6cef2b42e39116">u8vec4</a>(255, 27, 27, 255), 0.5f));</div><div class="line">  seq.<a class="code" href="../../d6/de3/classfastuidraw_1_1_color_stop_sequence.html#aa2b72211f82b6e96adb5600ea0ec29ec">add</a>(<a class="code" href="../../dd/d78/classfastuidraw_1_1_color_stop.html">ColorStop</a>(<a class="code" href="../../da/d46/group___utility.html#ga562bee0305892c513b6cef2b42e39116">u8vec4</a>(127, 255, 27, 255), 0.75f));</div><div class="line">  seq.<a class="code" href="../../d6/de3/classfastuidraw_1_1_color_stop_sequence.html#aa2b72211f82b6e96adb5600ea0ec29ec">add</a>(<a class="code" href="../../dd/d78/classfastuidraw_1_1_color_stop.html">ColorStop</a>(<a class="code" href="../../da/d46/group___utility.html#ga562bee0305892c513b6cef2b42e39116">u8vec4</a>(255, 255, 255, 27), 1.0f));</div><div class="line">  m_color_stops = <a class="code" href="../../da/d46/group___utility.html#ga524a8b6674554f360cf8b04a3a6a37b0">FASTUIDRAWnew</a> <a class="code" href="../../d8/d4e/classfastuidraw_1_1_color_stop_sequence_on_atlas.html">ColorStopSequenceOnAtlas</a>(seq, m_painter_engine_gl-&gt;colorstop_atlas(), 8);</div><div class="line">  m_custom_brush_shader = create_wavy_custom_brush(m_painter_engine_gl.get());</div><div class="line">  <span class="keywordflow">if</span> (!m_custom_brush_shader)</div><div class="line">    {</div><div class="line">      end_demo(-1);</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (argc &gt;= 2)</div><div class="line">    {</div><div class="line">      ImageSourceSDL image_loader(argv[1]);</div><div class="line">      m_image = m_painter_engine_gl-&gt;image_atlas().create(image_loader.width(),</div><div class="line">                                                          image_loader.height(),</div><div class="line">                                                          image_loader);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">ExampleCustomBrush::</div><div class="line">draw_frame(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">  <a class="code" href="../../d1/d96/classfastuidraw_1_1vec_n.html">fastuidraw::vec2</a> window_dims(window_dimensions());</div><div class="line">  <a class="code" href="../../d2/d7d/classfastuidraw_1_1_painter_surface_1_1_viewport.html">fastuidraw::PainterSurface::Viewport</a> vwp(0, 0, window_dims.x(), window_dims.y());</div><div class="line"></div><div class="line">  m_surface_gl-&gt;viewport(vwp);</div><div class="line">  m_painter-&gt;begin(m_surface_gl, <a class="code" href="../../d6/db7/classfastuidraw_1_1_painter_enums.html#a3e96faa847c849ddd2caea92b8a877e5a6e7fc1351dcd45f3d81025656670414c">fastuidraw::Painter::y_increases_downwards</a>);</div><div class="line"></div><div class="line">  <span class="comment">/* For this simple example, we will use SDL_GetTicks() to</span></div><div class="line"><span class="comment">   * get the number of milliseconds since the application started.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  uint32_t t;</div><div class="line">  t = SDL_GetTicks() % 4000u;</div><div class="line"></div><div class="line">  <span class="comment">/* Create an instance of our custom brush on the stack. */</span></div><div class="line">  ExampleCustomBrushData brush;</div><div class="line"></div><div class="line">  <span class="comment">/* first set PainterBrush from which our custom brush builds</span></div><div class="line"><span class="comment">   * to have a linear gradient with no color modulation applied.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  brush.m_brush_values</div><div class="line">    .color(1.0f, 1.0f, 1.0f, 1.0f)</div><div class="line">    .linear_gradient(m_color_stops,</div><div class="line">                     window_dims * 0.45f,</div><div class="line">                     window_dims * 0.55f,</div><div class="line">                     <a class="code" href="../../d9/d57/classfastuidraw_1_1_painter_brush.html#a698a81d6a833ef1972e25846fadd1497aeccde09fc63f8b01c2c35448309b68da">fastuidraw::PainterBrush::spread_mirror_repeat</a>);</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (m_image)</div><div class="line">    {</div><div class="line">      <span class="comment">/* Have the brush modulate against an image as well. */</span></div><div class="line">      brush.m_brush_values.image(m_image);</div><div class="line"></div><div class="line">      <span class="comment">/* apply a repeat window to the brush the size of the image */</span></div><div class="line">      brush.m_brush_values.repeat_window(<a class="code" href="../../d1/d96/classfastuidraw_1_1vec_n.html">fastuidraw::vec2</a>(0.0f, 0.0f),</div><div class="line">                                         <a class="code" href="../../d1/d96/classfastuidraw_1_1vec_n.html">fastuidraw::vec2</a>(m_image-&gt;dimensions()));</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="comment">/* Now set the values of the m_phase, m_amplitide to animate the wave.</span></div><div class="line"><span class="comment">   * The value of m_period is used to determine the period of the wave.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keywordtype">float</span> tf;</div><div class="line">  tf = 2.0f * <a class="code" href="../../da/d46/group___utility.html#ga82cb578eef1431ee8e6ee0a217226a4c">FASTUIDRAW_PI</a> / 4000.0f * <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(t);</div><div class="line">  brush.m_phase = window_dims.y() * <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(t) / 4000.0f;</div><div class="line">  brush.m_period = window_dims.y();</div><div class="line">  brush.m_amplitude = 0.1f * window_dims.x() * <a class="code" href="../../da/d46/group___utility.html#ga89048d9ce1ea9623d7c62c18120ca8b4">fastuidraw::t_cos</a>(tf);</div><div class="line"></div><div class="line">  <span class="comment">/* Create a fastuidraw::PainterCustomBrush that sources data from</span></div><div class="line"><span class="comment">   * our ExampleCustomBrushData instance, brush, and uses our custom</span></div><div class="line"><span class="comment">   * shader brush. Note that the -address- of ExampleCustomBrushData</span></div><div class="line"><span class="comment">   * is passed.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <a class="code" href="../../df/d9f/classfastuidraw_1_1_painter_data_1_1_custom_brush.html">fastuidraw::PainterCustomBrush</a> custom_brush(m_custom_brush_shader.get(),</div><div class="line">                                              &amp;brush);</div><div class="line"></div><div class="line">  <span class="comment">/* Fill a rect with out custom brush. */</span></div><div class="line">  m_painter-&gt;fill_rect(custom_brush,</div><div class="line">                       <a class="code" href="../../d3/d44/classfastuidraw_1_1_rect_t.html">fastuidraw::Rect</a>()</div><div class="line">                       .min_point(0.0f, 0.0f)</div><div class="line">                       .max_point(window_dims));</div><div class="line"></div><div class="line">  m_painter-&gt;end();</div><div class="line"></div><div class="line">  fastuidraw_glBindFramebuffer(GL_DRAW_FRAMEBUFFER, 0);</div><div class="line">  fastuidraw_glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT | GL_STENCIL_BUFFER_BIT);</div><div class="line">  m_surface_gl-&gt;blit_surface(GL_NEAREST);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div><div class="line">{</div><div class="line">  DemoRunner demo_runner;</div><div class="line">  <span class="keywordflow">return</span> demo_runner.main&lt;ExampleCustomBrush&gt;(argc, argv);</div><div class="line">}</div><div class="line"></div></div><!-- fragment --></div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
